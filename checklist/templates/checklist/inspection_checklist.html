{% extends 'base.html' %}
{% load static %}

{% block links %}
    <link rel="stylesheet" href="/static/css/select2.css">
    <link rel="stylesheet" href="/static/css/checklist.css">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <!-- Cabeçalho -->
            <a href="{% url 'checklist:checklist' %}" class="btn btn-white mb-3">
                <i class="bi bi-arrow-left me-2"></i>Voltar para Checklists
            </a>
            <div class="d-flex align-items-center gap-3 mb-4">
                <div class="flex-grow-1">
                    <h1 class="h2 fw-bold text-dark" id="checklist-title">Carregando Checklist...</h1>
                    <p class="text-muted mb-0" id="questions-info">0 questões</p>
                </div>
            </div>

            <!-- Alerta de erro -->
            <div class="alert alert-danger d-none" id="error-alert" role="alert">
                <i class="bi bi-exclamation-circle me-2"></i>
                <span id="error-message"></span>
            </div>

            <!-- Lista de questões -->
            <div id="questions-container">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-3">Carregando questões...</p>
                </div>
            </div>

            <!-- Rodapé com estatísticas e botão de envio -->
            <div class="card mt-4 d-none" id="footer-card">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <p class="fw-medium text-dark mb-1" id="progress-text">0 de 0 questões respondidas</p>
                            <p class="small text-muted mb-0">
                                <span id="compliant-count">0</span> conformes • 
                                <span id="non-compliant-count">0</span> não conformes
                            </p>
                        </div>
                        <button class="btn btn-primary btn-lg" id="submit-btn">
                            Enviar Inspeção
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de conclusão -->
<div class="modal fade" id="completion-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-success">Inspeção Concluída!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="checklist-complete-title" class="text-muted"></p>
                
                <div class="row text-center my-4">
                    <div class="col-4">
                        <div class="bg-primary bg-opacity-10 p-3 rounded">
                            <div class="h4 fw-bold text-primary" id="total-answered">0</div>
                            <div class="small text-primary">Total Respondido</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="bg-success bg-opacity-10 p-3 rounded">
                            <div class="h4 fw-bold text-success" id="compliant-count-modal">0</div>
                            <div class="small text-success">Conformes</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="bg-danger bg-opacity-10 p-3 rounded">
                            <div class="h4 fw-bold text-danger" id="non-compliant-count-modal">0</div>
                            <div class="small text-danger">Não Conformes</div>
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2">
                    <a href="/" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i>Voltar para Início
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Obter o ID do checklist da URL
    const pathParts = window.location.pathname.split('/');
    const checklistId = pathParts[pathParts.length - 2];
    
    // Elementos da interface
    const questionsContainer = document.getElementById('questions-container');
    const errorAlert = document.getElementById('error-alert');
    const errorMessage = document.getElementById('error-message');
    const footerCard = document.getElementById('footer-card');
    const submitBtn = document.getElementById('submit-btn');
    const completionModal = new bootstrap.Modal(document.getElementById('completion-modal'));
    
    // Estado da aplicação
    let checklistData = null;
    let questions = [];
    let responses = {};
    
    // Função para buscar dados do checklist
    async function fetchChecklist() {
        try {
            const response = await fetch(`/api/checklists/inspection/${checklistId}/`);
            if (!response.ok) {
                throw new Error('Checklist não encontrado');
            }
            checklistData = await response.json();
            displayChecklist();
        } catch (error) {
            showError(error.message || 'Erro ao carregar o checklist');
        }
    }
    
    // Função para exibir o checklist
    function displayChecklist() {
        if (!checklistData.data) return;
        
        // Atualizar título
        document.getElementById('checklist-title').textContent = checklistData.data.nome;
        document.getElementById('checklist-complete-title').textContent = checklistData.data.nome;
        document.getElementById('questions-info').textContent = `${checklistData.data.perguntas.length} questões`;
        
        // Renderizar questões
        questionsContainer.innerHTML = '';
        
        checklistData.data.perguntas.forEach((pergunta, index) => {
            const questionHtml = `
                <div class="card mb-4 question-card" id="question-${pergunta.id}">
                    <div class="card-header">
                        <div class="d-flex gap-2 mb-2">
                            <span class="badge bg-secondary">#${index + 1}</span>
                            <span class="badge bg-danger d-none required-badge">Obrigatório</span>
                        </div>
                        <h5 class="card-title">${pergunta.texto}</h5>
                    </div>
                    <div class="card-body">
                        <!-- Botões de conformidade -->
                        <div class="mb-3">
                            <label class="form-label">Status de Conformidade</label>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-outline-success flex-grow-1 compliance-btn" data-question="${pergunta.id}" data-compliant="true">
                                    <i class="bi bi-check-circle me-2"></i>Conforme
                                </button>
                                <button type="button" class="btn btn-outline-danger flex-grow-1 compliance-btn" data-question="${pergunta.id}" data-compliant="false">
                                    <i class="bi bi-x-circle me-2"></i>Não Conforme
                                </button>
                            </div>
                        </div>
                        
                        <!-- Notas -->
                        <div class="mb-3">
                            <label for="notes-${pergunta.id}" class="form-label">Observações</label>
                            <textarea class="form-control notes-input" id="notes-${pergunta.id}" data-question="${pergunta.id}" rows="3" placeholder="Adicione observações sobre esta questão..."></textarea>
                        </div>
                    </div>
                </div>
            `;
            
            questionsContainer.innerHTML += questionHtml;
            questions.push(pergunta);
            
            // Inicializar resposta vazia para esta pergunta
            responses[pergunta.id] = {
                conformidade: null,
                observacao: ''
            };
        });
        
        // Mostrar rodapé
        footerCard.classList.remove('d-none');
        updateProgress();
        
        // Adicionar event listeners aos botões
        document.querySelectorAll('.compliance-btn').forEach(btn => {
            btn.addEventListener('click', handleComplianceClick);
        });
        
        document.querySelectorAll('.notes-input').forEach(input => {
            input.addEventListener('input', handleNotesInput);
        });
    }
    
    // Manipulador de clique nos botões de conformidade
    function handleComplianceClick(e) {
        const questionId = e.target.dataset.question;
        const isCompliant = e.target.dataset.compliant === 'true';
        
        // Atualizar estado do botão
        document.querySelectorAll(`.compliance-btn[data-question="${questionId}"]`).forEach(btn => {
            if (btn.dataset.compliant === 'true') {
                btn.classList.toggle('btn-success', isCompliant);
                btn.classList.toggle('btn-outline-success', !isCompliant);
            } else {
                btn.classList.toggle('btn-danger', !isCompliant);
                btn.classList.toggle('btn-outline-danger', isCompliant);
            }
        });
        
        // Atualizar resposta
        responses[questionId].conformidade = isCompliant;
        updateProgress();
    }
    
    // Manipulador de entrada de observações
    function handleNotesInput(e) {
        const questionId = e.target.dataset.question;
        responses[questionId].observacao = e.target.value;
    }
    
    // Atualizar barra de progresso
    function updateProgress() {
        const answered = Object.values(responses).filter(r => r.conformidade !== null).length;
        const compliant = Object.values(responses).filter(r => r.conformidade === true).length;
        const nonCompliant = Object.values(responses).filter(r => r.conformidade === false).length;
        
        document.getElementById('progress-text').textContent = `${answered} de ${questions.length} questões respondidas`;
        document.getElementById('compliant-count').textContent = compliant;
        document.getElementById('non-compliant-count').textContent = nonCompliant;
        
        document.getElementById('total-answered').textContent = answered;
        document.getElementById('compliant-count-modal').textContent = compliant;
        document.getElementById('non-compliant-count-modal').textContent = nonCompliant;
    }
    
    // Função para enviar a inspeção
    async function submitInspection() {
        // Validar se todas as questões foram respondidas
        const unanswered = Object.entries(responses).filter(([id, r]) => r.conformidade === null);
        
        if (unanswered.length > 0) {
            showError('Por favor, responda todas as questões antes de enviar.');
            // Rolar para a primeira questão não respondida
            const firstUnansweredId = unanswered[0][0];
            document.getElementById(`question-${firstUnansweredId}`).scrollIntoView({ behavior: 'smooth' });
            return;
        }
        
        try {
            // Preparar dados para envio
            const inspectionData = {
                checklist: checklistId,
                respostas: Object.entries(responses).map(([perguntaId, resposta]) => ({
                    pergunta: perguntaId,
                    conformidade: resposta.conformidade,
                    observacao: resposta.observacao,
                    texto_pergunta_historico: questions.find(q => q.id == perguntaId).texto
                }))
            };
            
            // Enviar para a API
            const response = await fetch('/api/inspecoes/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(inspectionData)
            });
            
            if (!response.ok) {
                throw new Error('Erro ao enviar a inspeção');
            }
            
            // Mostrar modal de sucesso
            completionModal.show();
            
        } catch (error) {
            showError(error.message || 'Erro ao enviar a inspeção');
        }
    }
    
    // Função para obter o token CSRF
    function getCSRFToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Função para mostrar erro
    function showError(message) {
        errorMessage.textContent = message;
        errorAlert.classList.remove('d-none');
        
        // Esconder o alerta após 5 segundos
        setTimeout(() => {
            errorAlert.classList.add('d-none');
        }, 5000);
    }
    
    // Event listener para o botão de envio
    submitBtn.addEventListener('click', submitInspection);
    
    // Inicializar a página
    fetchChecklist();
});
</script>

<style>
.compliance-btn {
    transition: all 0.2s;
}

.question-card {
    transition: border-color 0.2s;
}

.question-card.unanswered {
    border-color: #dc3545;
    background-color: rgba(220, 53, 69, 0.05);
}
</style>
{% endblock %}